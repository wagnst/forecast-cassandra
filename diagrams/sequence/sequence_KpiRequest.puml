@startuml
hide footbox
participant  " "
participant  ":KpiRequest"
participant  ":Period"
participant  ":ValidatedResultTopdown"
participant  ":ZeroMonthPeriod"


" " -> ":KpiRequest" : calculateKpis()

":KpiRequest" -> ":KpiRequest" : calculateActualForecastKpis()
group calculateActualForecastKpis()
":KpiRequest" -> ":KpiRequest" : getActualData(tempPlanPeriod, currentPeriod)
":KpiRequest" -> ":KpiRequest" : ActualData
alt if actualData has current period
    ":KpiRequest" -> ":KpiRequest" : getForecastData(currentPeriod, Period)
    else else
    ":KpiRequest" -> ":Period" : currentPeriod.immutableIncrement()
    ":Period" --> ":KpiRequest" : Period
    ":KpiRequest" -> ":KpiRequest" : getForecastData(Period, tempPlanPeriod)
end
    ":KpiRequest" --> ":KpiRequest" : ForecastData

loop
":KpiRequest" -> ":ValidatedResultTopdown" : getTopdownResult()
":ValidatedResultTopdown" --> ":KpiRequest" : topdownResult
end

loop For actual and forecast data
   loop For each entity
         ":KpiRequest" -> ":KpiRequest" : validateTopdownQueryResult()
        loop For each validated result
            ":KpiRequest" -> ":ValidatedResultTopdown" : getKpiResult()
            ":ValidatedResultTopdown" --> ":KpiRequest" : monthlyKpiValues
            ":KpiRequest" -> ":ValidatedResultTopdown" : getTopdownResult()
            ":ValidatedResultTopdown" --> ":KpiRequest" : monthlyTopdownValues
        end
   end
end

loop Number of bj
    ":KpiRequest" -> ":KpiRequest" : calculateBjTopdown(Period)
    loop kpiArray
        ":KpiRequest" -> ":ValidatedResultTopdown" : getKpiResult()
        ":ValidatedResultTopdown" --> ":KpiRequest" : KpiResult
        ":KpiRequest" -> ":ValidatedResultTopdown" : getTopdownResult()
        ":ValidatedResultTopdown" --> ":KpiRequest" : topdownBjValues
    end
    ":KpiRequest" -> ":ZeroMonthPeriod" : increment()
    ":ZeroMonthPeriod" --> ":KpiRequest" : bjPeriod
end

loop
       ":KpiRequest" -> ":KpiRequest" : createOutputDataType(monthlyKpiValues, bjValues)
end

loop
    ":KpiRequest" -> ":KpiRequest" : createOutputDataType(topdownKpiValues, topdownBjValues)
end

":KpiRequest" -> ":Stream" : Stream.concat(resultStream, resultStreamTopdown)
":Stream" --> ":KpiRequest" : Stream<OutputDataType>
end

":KpiRequest" -> ":KpiRequest" : calculateBudgetKpis()
group calculateBudgetKpis()
loop NumberOfMonths
    ":KpiRequest" -> ":KpiRequest" : validateQueryResult(BudgetData, tempPlanPeriod)
    loop kpiArray
        ":KpiRequest" -> ":ValidatedResult" : getKpiResult()
        ":ValidatedResult" --> ":KpiRequest" : monthlyKpiValues
    end
        ":KpiRequest" -> ":Period" : increment()
        ":Period" -> ":KpiRequest" : tempPlanPeriod
end

loop NumberOfBj
    ":KpiRequest" -> ":KpiRequest" : calculateBj(bjPeriod)
    loop kpiArray
        ":KpiRequest" -> ":ValidatedResult": getKpiResult()
        ":ValidatedResult" --> ":KpiRequest": bjValues
    end
    ":KpiRequest" -> ":ZeroMonthPeriod" : increment()
    ":ZeroMonthPeriod" --> ":KpiRequest" : bjPeriod
end

loop kpiArray
    ":KpiRequest" -> ":KpiRequest" : createOutputDataType(monthlyKpiValues, bjValues)
end
end

":KpiRequest" -> ":Stream" : concat(entryTypeNull, entryTypeBudget)
":Stream" --> ":KpiRequest" : Stream<OutputDataType>

":KpiRequest" --> " " : Stream<OutputDataType>
@enduml